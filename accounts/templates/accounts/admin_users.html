{% extends "base.html" %}
{% load static %}

{% block title %}User Management - Admin - GT Job Finder{% endblock %}

{% block content %}
<style>
    .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px 20px;
    }
    
    .admin-header {
        background: linear-gradient(135deg, #003057 0%, #B3A369 100%);
        color: white;
        padding: 40px;
        border-radius: 16px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    }
    
    .admin-header h1 {
        margin: 0 0 10px 0;
        font-size: 32px;
        font-weight: 700;
    }
    
    .admin-nav {
        display: flex;
        gap: 12px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    
    .admin-nav a {
        padding: 12px 24px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        text-decoration: none;
        color: #003057;
        font-weight: 600;
        transition: all 0.2s;
    }
    
    .admin-nav a:hover, .admin-nav a.active {
        background: #003057;
        color: white;
        border-color: #003057;
    }
    
    .content-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .filters {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }
    
    .filters input, .filters select {
        padding: 10px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        min-width: 200px;
    }
    
    .filters button {
        padding: 10px 24px;
        background: #003057;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }
    
    .filters button:hover {
        background: #002544;
    }
    
    .user-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .user-table th {
        text-align: left;
        padding: 12px;
        background: #f9fafb;
        border-bottom: 2px solid #e5e7eb;
        font-weight: 600;
        color: #374151;
    }
    
    .user-table td {
        padding: 16px 12px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .user-table tr:hover {
        background: #f9fafb;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .badge-seeker { background: #dbeafe; color: #1e40af; }
    .badge-recruiter { background: #fef3c7; color: #92400e; }
    .badge-active { background: #d1fae5; color: #065f46; }
    .badge-inactive { background: #fee2e2; color: #991b1b; }
    .badge-staff { background: #e0e7ff; color: #3730a3; }
    
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    
    .btn {
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    
    .btn-warning { background: #f59e0b; color: white; }
    .btn-warning:hover { background: #d97706; }
    
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    
    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }
</style>

<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-users"></i> User Management</h1>
        <p>Manage user accounts, roles, and access</p>
    </div>
    
    <div class="admin-nav">
        <a href="{% url 'accounts:admin_dashboard' %}">
            <i class="fas fa-home"></i> Dashboard
        </a>
        <a href="{% url 'accounts:admin_users' %}" class="active">
            <i class="fas fa-users"></i> User Management
        </a>
        <a href="{% url 'accounts:admin_jobs' %}">
            <i class="fas fa-briefcase"></i> Job Moderation
        </a>
    </div>
    
    <div class="content-section">
        <form method="GET" class="filters">
            <input type="text" name="search" placeholder="Search by username, email, name..." 
                   value="{{ search_query }}" />
            <select name="type">
                <option value="">All User Types</option>
                <option value="job_seeker" {% if user_type == 'job_seeker' %}selected{% endif %}>Job Seekers</option>
                <option value="recruiter" {% if user_type == 'recruiter' %}selected{% endif %}>Recruiters</option>
            </select>
            <button type="submit"><i class="fas fa-search"></i> Filter</button>
        </form>
        
        <table class="user-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Email</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr data-user-id="{{ user.id }}">
                    <td>
                        <strong>{{ user.username }}</strong>
                        {% if user.first_name or user.last_name %}
                        <br><small style="color: #6b7280;">{{ user.first_name }} {{ user.last_name }}</small>
                        {% endif %}
                        {% if user.is_superuser %}
                        <br><span class="badge badge-staff">SUPERUSER</span>
                        {% elif user.is_staff %}
                        <br><span class="badge badge-staff">STAFF</span>
                        {% endif %}
                    </td>
                    <td>{{ user.email|default:"No email" }}</td>
                    <td>
                        {% if user.profile %}
                            <span class="badge badge-{{ user.profile.user_type }}">
                                {{ user.profile.get_user_type_display }}
                            </span>
                        {% else %}
                            <span class="badge badge-secondary">No Profile</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge {% if user.is_active %}badge-active{% else %}badge-inactive{% endif %}">
                            {% if user.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </td>
                    <td>{{ user.date_joined|date:"M d, Y" }}</td>
                    <td>
                        <div class="action-buttons">
                            {% if not user.is_superuser %}
                                <button class="btn btn-warning" onclick="changeRole({{ user.id }}, '{% if user.profile.user_type == 'job_seeker' %}recruiter{% else %}job_seeker{% endif %}')">
                                    <i class="fas fa-exchange-alt"></i> Switch Role
                                </button>
                                <button class="btn {% if user.is_active %}btn-secondary{% else %}btn-success{% endif %}" 
                                        onclick="toggleStatus({{ user.id }})">
                                    <i class="fas fa-{% if user.is_active %}ban{% else %}check{% endif %}"></i>
                                    {% if user.is_active %}Deactivate{% else %}Activate{% endif %}
                                </button>
                                <button class="btn btn-danger" onclick="deleteUser({{ user.id }}, '{{ user.username }}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            {% else %}
                                <span style="color: #6b7280; font-size: 13px;">Protected</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                        No users found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleStatus(userId) {
    if (!confirm('Are you sure you want to change this user\'s status?')) return;
    
    fetch(`/accounts/admin/users/${userId}/toggle-status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('An error occurred: ' + error);
    });
}

function changeRole(userId, newRole) {
    if (!confirm(`Are you sure you want to change this user's role to ${newRole}?`)) return;
    
    fetch(`/accounts/admin/users/${userId}/change-role/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ role: newRole })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('An error occurred: ' + error);
    });
}

function deleteUser(userId, username) {
    if (!confirm(`Are you sure you want to PERMANENTLY DELETE user "${username}"? This action cannot be undone!`)) return;
    
    fetch(`/accounts/admin/users/${userId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('An error occurred: ' + error);
    });
}
</script>
{% endblock %}

